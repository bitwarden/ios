name: 'macOS Runner Tuneup'
description: 'Optimizes macOS GitHub runners by disabling resource-heavy background processes'
author: 'Bitwarden'

runs:
  using: 'composite'
  steps:
    - name: Optimize macOS Runner
      shell: bash
      run: |
        echo "ğŸš€ Starting macOS Runner Tuneup..."
        echo "=================================="

        echo "ğŸ” Disabling Spotlight..."
        sudo mdutil -a -i off # disables indexing on all volumes
        sudo mdutil -a -d # disables spotlight activity on all volumes
        sudo mdutil -E / # deletes existing index
        sudo defaults write /System/Library/LaunchAgents/com.apple.Spotlight.plist Disabled -bool true || true

        echo "ğŸ” Disabling Spotlight Knowledge Daemon..."
        sudo launchctl disable system/com.apple.spotlightknowledged
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.spotlightknowledged.plist || true
        sudo pkill -SIGKILL spotlightknowledged || true

        echo "ğŸ›‘ Disabling metadata services..."
        sudo launchctl disable system/com.apple.metadata.mds || true
        sudo launchctl disable system/com.apple.metadata.mds.index || true
        sudo launchctl disable system/com.apple.metadata.mds.scan || true

        echo "ğŸ“¦ Unloading metadata plists..."
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.metadata.mds.plist || true
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.metadata.mds.index.plist || true
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.metadata.mds.scan.plist || true
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.metadata.mdwrite.plist || true

        echo "âš¡ Killing metadata processes..."
        sudo pkill -SIGKILL -f "Metadata.framework/Versions/A/Support/mds" || true
        sudo pkill -SIGKILL Spotlight || true
        echo "âœ… Spotlight disabled!"

        echo "ğŸ’¥ Disabling ReportCrash..."
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.ReportCrash.plist || true
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.ReportCrash.Root.plist || true
        sudo launchctl disable system/com.apple.ReportCrash || true
        sudo launchctl disable system/com.apple.ReportCrash.Root || true
        defaults write com.apple.CrashReporter DialogType none
        echo "âœ… ReportCrash disabled!"

        echo "ğŸŒ± Disabling EcosystemD..."
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.ecosystemd.plist || true
        sudo pkill -SIGKILL -f "ecosystemd" || true
        echo "âœ… EcosystemD disabled!"

        echo "ğŸŒ± Disabling EcosystemAnalyticsD..."
        sudo launchctl bootout system/com.apple.ecosystemanalyticsd || true
        echo "âœ… EcosystemAnalyticsD disabled!"

        echo "ğŸŒ± Disabling SubmitDiagInfo..."
        defaults write /Library/Preferences/com.apple.SubmitDiagInfo AutoSubmit -bool false

        echo "ğŸŒ Disabling location services..."
        defaults write /Library/Preferences/com.apple.locationd.plist LocationServicesEnabled -int 0

        echo "ğŸ” Disabling Siri..."
        defaults write com.apple.assistant.support Assistant\ Enabled -bool false
        defaults write com.apple.Siri StatusMenuVisible -bool false

        echo "ğŸ”’ Disabling iCloud analytics and usage tracking..."
        defaults write com.apple.UsageTracking CoreDonationsEnabled -bool false
        defaults write com.apple.UsageTracking UDCAutomationEnabled -bool false

        echo "ğŸ” Disabling Spotlight suggestions..."
        defaults write com.apple.lookup.shared LookupSuggestionsDisabled -bool true

        echo "ğŸ“Š Process Information After Tuning"
        echo "=================================="
        echo "ğŸ§  Sorted by memory usage:"
        head -n20 < <(ps -emo pid,pcpu,pmem,comm)
        echo ""
        echo "ğŸ”¥  Sorted by CPU usage:"
        head -n20 < <(ps -ero pid,pcpu,pmem,comm)
        echo ""
        echo "ğŸ‰ macOS Runner Tuneup Complete!"

