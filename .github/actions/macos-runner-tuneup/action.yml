name: 'macOS Runner Tuneup'
description: 'Optimizes macOS GitHub runners by disabling resource-heavy background processes'
author: 'Bitwarden'

runs:
  using: 'composite'
  steps:
    - name: Optimize macOS Runner
      shell: bash
      run: |
        echo "ğŸš€ Starting macOS Runner Tuneup..."
        echo "=================================="

        echo "ğŸ” Disabling Spotlight..."
        sudo mdutil -a -i off

        echo "ğŸ›‘ Disabling metadata services..."
        sudo launchctl disable system/com.apple.metadata.mds || true
        sudo launchctl disable system/com.apple.metadata.mds.index || true
        sudo launchctl disable system/com.apple.metadata.mds.scan || true

        echo "ğŸ“¦ Unloading metadata plists..."
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.metadata.mds.plist || true
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.metadata.mds.index.plist || true
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.metadata.mds.scan.plist || true
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.metadata.mdwrite.plist || true

        echo "âš¡ Killing metadata processes..."
        sudo pkill -SIGKILL -f "Metadata.framework/Versions/A/Support/mds" || true
        sudo pkill -SIGKILL Spotlight || true
        echo "âœ… Spotlight disabled!"

        echo "ğŸ’¥ Disabling ReportCrash..."
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.ReportCrash.plist || true
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.ReportCrash.Root.plist || true
        sudo launchctl disable system/com.apple.ReportCrash || true
        sudo launchctl disable system/com.apple.ReportCrash.Root || true
        echo "âœ… ReportCrash disabled!"

        echo "ğŸŒ± Disabling EcosystemD..."
        sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.ecosystemd.plist || true
        sudo pkill -SIGKILL -f "ecosystemd" || true
        echo "âœ… EcosystemD disabled!"

        echo "ğŸ“Š Process Information After Tuning"
        echo "=================================="
        echo "ğŸ§  Sorted by memory usage:"
        ps -em -o pid,pcpu,pmem,comm | head -n20
        echo ""
        echo "âš¡ Sorted by CPU usage:"
        ps -er -o pid,pcpu,pmem,comm | head -n20
        echo ""
        echo "ğŸ‰ macOS Runner Tuneup Complete!"

