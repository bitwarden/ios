
name: Publish to iOS App Store
run-name: Publish build ${{ inputs.build-number }} version ${{inputs.build-version}}

on:
  workflow_dispatch:
    inputs:
      product:
        description: "App Being Updated"
        required: true
        default: "Password Manager"
        type: choice
        options:
          - Password Manager
          - Authenticator
      build-version:
        description: "Version Name - e.g. '2024.8.1'"
        type: string
        default: "2025.5.0" #fixme
      build-number:
        description: "Version Number Override - e.g. '1021'"
        type: string
        default: "2122" #fixme
      changelog:
        description: "Release Notes"
        type: string
        default: "Bug Fixes."
      update-screenshots:
        description: "Update Screenshots"
        type: boolean
        default: false
      phased-release:
        description: "Publish This Release in Phases - e.g. 1%, 3%.."
        type: boolean
        default: true
      

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITHUB_ACTION_RUN_URL: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

permissions:
  contents: read
  packages: read

jobs:
    publish:
      name: Publish build ${{ inputs.build-number }} version ${{inputs.build-version}}
      runs-on: macos-15

      steps:
        - name: Log inputs to job summary
          run: |
            echo "<details><summary>Job Inputs</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo '${{ toJson(inputs) }}' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY

        - name: Check out repo
          uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

        - name: Configure Ruby
          uses: ruby/setup-ruby@ca041f971d66735f3e5ff1e21cc13e2d51e7e535 # v1.233.0
          with:
            bundler-cache: true

        - name: Install Homebrew Dependencies
          run: |
            brew update
            brew bundle

        - name: Log in to Azure
          uses: Azure/login@cb79c773a3cfa27f31f25eb3f677781210c9ce3d # v1.6.1
          with:
            creds: ${{ secrets.AZURE_KV_CI_SERVICE_PRINCIPAL }}

        - name: Retrieve secrets
          uses: bitwarden/gh-actions/get-keyvault-secrets@main
          with:
            keyvault: "bitwarden-ci"
            secrets: "appcenter-ios-token"

        - name: Retrieve beta provisioning profiles
          env:
            ACCOUNT_NAME: bitwardenci
            CONTAINER_NAME: profiles
            FILE: dist_beta_bitwarden.mobileprovision
          run: |
            mkdir -p $HOME/secrets
            az storage blob download --account-name $ACCOUNT_NAME --container-name $CONTAINER_NAME --name $FILE \
                --file $HOME/secrets/$FILE --output none

        - name: Retrieve certificates
          run: |
            mkdir -p $HOME/certificates
            az keyvault secret show --id https://bitwarden-ci.vault.azure.net/certificates/ios-distribution |
              jq -r .value | base64 -d > $HOME/certificates/ios-distribution.p12

        - name: Download Fastlane credentials
          env:
            ACCOUNT_NAME: bitwardenci
            CONTAINER_NAME: mobile
            FILE: appstoreconnect-fastlane.json
          run: |
            mkdir -p $HOME/secrets
            az storage blob download --account-name $ACCOUNT_NAME --container-name $CONTAINER_NAME --name $FILE \
              --file $HOME/secrets/$FILE --output none

        - name: Configure Keychain Access
          env:
            KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
          run: |
            security create-keychain -p $KEYCHAIN_PASSWORD build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p $KEYCHAIN_PASSWORD build.keychain
            security set-keychain-settings -lut 1200 build.keychain

            security import $HOME/certificates/ios-distribution.p12 -k build.keychain -P "" -T /usr/bin/codesign \
              -T /usr/bin/security
            security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k $KEYCHAIN_PASSWORD build.keychain

        - name: Update beta Fastlane Appfile
          run: |
            echo 'app_identifier "com.8bit.bitwarden.beta"' > fastlane/Appfile

        - name: Set up private auth key
          run: |
            mkdir ~/private_keys
            cat << EOF > ~/private_keys/AuthKey_J46C83CB96.p8
            ${{ secrets.APP_STORE_CONNECT_AUTH_KEY }}
            EOF

        - name: Upload app to with Fastlane
          env:
            VERSION_CODE: ${{ inputs.build-number }}
            VERSION_NAME: ${{inputs.build-version}}
            PHASED_RELEASE: ${{ inputs.phased-release }}
            PRODUCT: ${{ inputs.product }}
            UPDATE_SCREENSHOTS: ${{ inputs.update-screenshots}}
            CHANGELOG: ${{ inputs.changelog }}
            FASTLANE_ENABLE_BETA_DELIVER_SYNC_SCREENSHOTS: true
          run: |
            run: |
            if [ "$PRODUCT" = "Password Manager" ]; then
              PACKAGE_NAME="com.8bit.bitwarden.beta"
            elif [ "$PRODUCT" = "Authenticator" ]; then
              PACKAGE_NAME="com.bitwarden.authenticator"
            else
              echo "Unsupported product: $PRODUCT"
              exit 1
            fi

            if [ "$UPDATE_SCREENSHOTS" = true ]; then
              skip_screenshots=false
              sync_screenshots=true
            else
              skip_screenshots=true
              sync_screenshots=false
            fi

            bundle exec fastlane updateReleaseNotes

            bundle exec fastlane submit_release \
              api_key_path:"$HOME/secrets/appstoreconnect-fastlane.json" \
              build_number:"$VERSION_CODE" \
              app_version:"$VERSION_NAME" \
              skip_screenshots:$skip_screenshots \
              sync_screenshots:$sync_screenshots \
              phased_release:"$PHASED_RELEASE" \
              app_identifier:"$PACKAGE_NAME" \
              changelog:"$CHANGELOG" \