
name: Publish to iOS App Store
run-name: >
  ${{ inputs.dry-run && ' (Dry Run)' || '' }} Publish ${{ inputs.product }} build ${{ inputs.build-number }} version ${{ inputs.build-version }}

on:
  workflow_dispatch:
    inputs:
      product:
        description: "App Being Updated"
        required: true
        default: "Password Manager"
        type: choice
        options:
          - Password Manager
          - Authenticator
      build-version:
        description: "Version Name - e.g. '2024.8.1'"
        type: string
      build-number:
        description: "Version Number Override - e.g. '1021'"
        type: string
      changelog:
        description: "Release Notes"
        type: string
      phased-release:
        description: "Publish This Release in Phases - e.g. 1%, 3%.."
        type: boolean
        default: true
      submit-release:
        description: "Automatically submit release for review"
        type: boolean
        default: true
      dry-run:
        description: "Dry-Run, Run the workflow without publishing to the store"
        type: boolean
        default: false

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITHUB_ACTION_RUN_URL: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

permissions:
  contents: read
  packages: read
  id-token: write
  actions: write

jobs:
    publish:
      name: Publish build ${{ inputs.build-number }} version ${{inputs.build-version}}
      runs-on: macos-26

      steps:
        - name: Log inputs to job summary
          uses: bitwarden/ios/.github/actions/log-inputs@main
          with:
            inputs: "${{ toJson(inputs) }}"

        - name: Check out repo
          uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
          with:
            persist-credentials: false

        - name: Configure Ruby
          uses: ruby/setup-ruby@44511735964dcb71245e7e55f72539531f7bc0eb # v1.257.0
          with:
            bundler-cache: true

        - name: Install Homebrew Dependencies
          run: |
            brew update
            brew bundle

        - name: Log in to Azure
          uses: bitwarden/gh-actions/azure-login@main
          with:
            subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
            tenant_id: ${{ secrets.AZURE_TENANT_ID }}
            client_id: ${{ secrets.AZURE_CLIENT_ID }}

        - name: Get Azure Key Vault secrets
          id: get-kv-secrets
          uses: bitwarden/gh-actions/get-keyvault-secrets@main
          with:
            keyvault: "gh-ios"
            secrets: "APP-STORE-CONNECT-AUTH-KEY"

        - name: Download Fastlane credentials
          env:
            ACCOUNT_NAME: bitwardenci
            CONTAINER_NAME: mobile
            FILE: appstoreconnect-fastlane.json
          run: |
            mkdir -p "$HOME/secrets"
            az storage blob download --account-name "$ACCOUNT_NAME" --container-name "$CONTAINER_NAME" --name "$FILE" \
              --file "$HOME/secrets/$FILE" --output none

        - name: Log out from Azure
          uses: bitwarden/gh-actions/azure-logout@main

        - name: Set up private auth key
          env:
            AUTH_KEY: ${{ steps.get-kv-secrets.outputs.APP-STORE-CONNECT-AUTH-KEY }}
          run: |
            mkdir ~/private_keys
            cat << EOF > ~/private_keys/AuthKey_J46C83CB96.p8
            $AUTH_KEY
            EOF

        - name: Upload app to with Fastlane
          id: publish
          env:
            VERSION_CODE: ${{ inputs.build-number }}
            VERSION_NAME: ${{inputs.build-version}}
            PHASED_RELEASE: ${{ inputs.phased-release }}
            PRODUCT: ${{ inputs.product }}
            CHANGELOG: ${{ inputs.changelog }}
            FASTLANE_ENABLE_BETA_DELIVER_SYNC_SCREENSHOTS: true
            SUBMIT_RELEASE: ${{ inputs.submit-release }}
            DRY_RUN: ${{ inputs.dry-run }}
          run: |
            if [ "$DRY_RUN" = "true" ]; then
              echo "ðŸ§ª DRY RUN MODE - Testing without actual App Store submission"
              echo "ðŸ“¦ Would publish build $VERSION_CODE to iOS App Store"
            else
              echo "ðŸš€ PRODUCTION MODE - Publishing to iOS App Store"
              echo "ðŸ“¦ Publishing build $VERSION_CODE to iOS App Store"
            fi

            if [ "$PRODUCT" = "Password Manager" ]; then
              PACKAGE_NAME="com.8bit.bitwarden"
              METADATA_PATH="metadata_bwpm_prod"
            elif [ "$PRODUCT" = "Authenticator" ]; then
              PACKAGE_NAME="com.bitwarden.authenticator"
              METADATA_PATH="metadata_bwa_prod"
            else
              echo "Unsupported product: $PRODUCT"
              exit 1
            fi

            bundle exec fastlane release_to_production \
              api_key_path:"$HOME/secrets/appstoreconnect-fastlane.json" \
              build_number:"$VERSION_CODE" \
              app_version:"$VERSION_NAME" \
              phased_release:"$PHASED_RELEASE" \
              app_identifier:"$PACKAGE_NAME" \
              changelog:"$CHANGELOG" \
              metadata_path:"$METADATA_PATH" \
              submit_release:"$SUBMIT_RELEASE" \
              dry_run:"$DRY_RUN"

        - name: Enable Publish Github Release Workflow
          if: ${{ steps.publish.conclusion == 'success' }}
          env:
            PRODUCT: ${{ inputs.product }}
          run: |
            if ${{ inputs.dry-run }} ; then
              gh workflow view publish-github-release.yml
              exit 0
            fi
            if [ "$PRODUCT" = "Password Manager" ]; then
              gh workflow enable publish-github-release-bwpm.yml
            elif [ "$PRODUCT" = "Authenticator" ]; then
              gh workflow enable publish-github-release-bwa.yml
            fi
